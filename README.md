
# MG-CRAG: Fusion of Multi-Granular Retrieval Evaluators in Corrective RAG with Weakly Supervised Fine-Tuning

This is the implementation for MG-CRAG paper. The MG-CRAG method refines retrieved documents in a Multi-Granular manner, utilizing two retrieval evaluators sequentially. The training of the evaluator models is performed using a weakly supervised approach, leveraging an autoencoder to create a separable latent space. Additionally, MG-CRAG introduces various mechanisms, each performing optimally under specific conditions, with the extent of web search usage being tunable for each.

This Section will be updated after the paper is published.




## Run Locally

For each stage in the original paper, there is a runnable notebook file in the notebooks folder. Each of them can be executed via Jupyter Notebook as well as Google Colab:

- [Step 0: Convert Texts to Embeddings Using T5-GTR](https://github.com/omidacoder/mg-crag/blob/main/notebooks/Step%200%20Convert%20Texts%20to%20Embeddings.ipynb)
 - [Step 1: Perform Clustering](https://github.com/omidacoder/mg-crag/blob/main/notebooks/Step%201%20Clustering.ipynb)
 - [Step 2: Train the ResidualNet as the Classification Head](https://github.com/omidacoder/mg-crag/blob/main/notebooks/Step%202%20Train%20Classification%20Head.ipynb)
 - [Step 3: Run Tests Using VLLM](https://github.com/omidacoder/mg-crag/blob/main/notebooks/Step%203%20Run%20Tests.ipynb)

## Required Hardware

All tests were conducted on an L4 GPU on Google Colab with 22 GB of memory. For running the retrieval section using the Contriever model, 100 GB of RAM is required. However, for executing the tests, high RAM is not necessary, and they can be run with as little as 12 GB of RAM.

## Downloads

All files generated by us for use in different parts of the project are available for download in this section:
- [Human Labeled Data](https://drive.google.com/drive/folders/1l5hQdUWQcR2-oWu3zFOTr64U83qZocPi?usp=sharing)
- [Selected Unlabeled Data](https://drive.google.com/drive/folders/1m5rQ4NmUlmv3nkKSJbuY5y0fR7qPNbtZ?usp=sharing)
- [Generated Embeddings](https://drive.google.com/drive/folders/10jQxf0lJ4jxoG7h92m2m_Mxz3oJIVPSa?usp=sharing)
- [Model Generations From Best Results](https://drive.google.com/drive/folders/1kNEFgow_JtfzBgflWKpnhAFBfon8VLKf?usp=sharing)

### ARC-Challenge
 - [ARC-Challenge Train Retrievals](https://drive.google.com/file/d/1-5bWtVSBMijXFLm5B2KXqWDwHNT_4Xfk/view?usp=sharing)
 - [ARC-Challenge Web Search Results](https://drive.google.com/file/d/1chB1lzsfI8zKHEISWoBBDf2p822PAJ6j/view?usp=sharing)
### PubHealth
 - [PubHealth Train Retrievals](https://drive.google.com/file/d/1mP6UB1qZbwzMN-gO6Es0YRf9_9Omyujj/view?usp=sharing)
 - [PubHealth Web Search Results](https://drive.google.com/file/d/1k97TjJvu8fM6JZLGFs29I9R5b0LPanaA/view?usp=sharing)
### PopQA
 - [PopQA Train Retrievals](https://drive.google.com/file/d/1XvcNFmeeO5l61XSaHf-5wsX92qWsq5mC/view?usp=sharing)
 - [PopQA Web Search Results](https://drive.google.com/file/d/1hvyRA7lCVj8jey6iTWLoSrwL-ZeGVPDO/view?usp=sharing)


These files are required in different parts of the notebooks. You can download our generated files or you can generate your pickle files using the notebooks.

Human labeled data has been labeled by our team, and you need to download it to get started. You can also use your own labeled data, provided it is in the same format as our labeled data, as human labeled data.

Files are in pickle format and can be opened in python using the following code:
```python
import pickle
file_path = "/path/to/anything.pickle"
with open(file_path, 'rb') as handle:
   loaded_file = pickle.load(handle)
# print or display the loaded file
print(loaded_file)
```

 This section will also be completed after the publication of the paper.

## Refferences

Some parts of the code in the project have been directly taken from the following repositories:

 - [Retrievals Using Contriever: Self-RAG](https://github.com/AkariAsai/self-rag)
 - [Prompts and Other CRAG Related Settings: CRAG](https://github.com/HuskyInSalt/CRAG)
 - [Project Structure and LangGraph implementation: CRAG LangGraph Implementation by Grecil](https://github.com/Grecil/Corrective-RAG)

we are thankful to them for sharing their codes.


